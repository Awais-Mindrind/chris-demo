<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sales Quoting Engine - SSE Streaming Demo</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .chat-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin: 20px 0;
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        background-color: #fafafa;
      }
      .message {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .user-message {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
      }
      .assistant-message {
        background-color: #f3e5f5;
        border-left: 4px solid #9c27b0;
      }
      .token {
        display: inline;
      }
      .input-container {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      button {
        padding: 10px 20px;
        background-color: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background-color: #1976d2;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        font-weight: bold;
      }
      .status.connecting {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .pdf-link {
        display: inline-block;
        margin-top: 10px;
        padding: 8px 16px;
        background-color: #28a745;
        color: white;
        text-decoration: none;
        border-radius: 4px;
      }
      .pdf-link:hover {
        background-color: #218838;
      }
      .session-info {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Sales Quoting Engine - SSE Streaming Demo</h1>
      <p>
        This demo shows real-time streaming of AI responses using Server-Sent
        Events (SSE).
      </p>

      <div class="status" id="status">Ready to connect</div>

      <div class="chat-container" id="chatContainer">
        <div class="message assistant-message">
          <strong>AI Assistant:</strong> Hello! I'm your sales quoting
          assistant. I can help you create quotes by asking a few questions
          about the account, products, and quantities. What would you like to
          do?
        </div>
      </div>

      <div class="input-container">
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message here..."
        />
        <button id="sendButton" onclick="sendMessage()">Send</button>
      </div>

      <div class="session-info" id="sessionInfo"></div>
    </div>

    <script>
      let eventSource = null;
      let currentMessage = "";
      let sessionId = null;

      function updateStatus(message, type = "") {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `status ${type}`;
      }

      function addMessage(content, isUser = false) {
        const container = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          isUser ? "user-message" : "assistant-message"
        }`;

        const prefix = isUser ? "You:" : "AI Assistant:";
        messageDiv.innerHTML = `<strong>${prefix}</strong> <span class="token">${content}</span>`;

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }

      function addPdfLink(pdfUrl, quoteId) {
        const container = document.getElementById("chatContainer");
        const linkDiv = document.createElement("div");
        linkDiv.className = "message assistant-message";
        linkDiv.innerHTML = `
                <strong>AI Assistant:</strong> Quote created successfully! 
                <a href="${pdfUrl}" class="pdf-link" target="_blank">Download PDF (Quote #${quoteId})</a>
            `;
        container.appendChild(linkDiv);
        container.scrollTop = container.scrollHeight;
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const button = document.getElementById("sendButton");
        const message = input.value.trim();

        if (!message) return;

        // Add user message
        addMessage(message, true);
        input.value = "";
        button.disabled = true;

        // Start streaming
        startStreaming(message);
      }

      function startStreaming(message) {
        if (eventSource) {
          eventSource.close();
        }

        updateStatus("Connecting to server...", "connecting");

        // Create new message container for streaming
        const container = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message assistant-message";
        messageDiv.innerHTML =
          '<strong>AI Assistant:</strong> <span class="token" id="currentResponse"></span>';
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;

        const responseSpan = document.getElementById("currentResponse");
        currentMessage = "";

        // Create EventSource
        const url = "/chat/stream";
        eventSource = new EventSource(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ message: message }),
        });

        // Send the actual request
        fetch("/chat/stream", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ message: message }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function readStream() {
              return reader.read().then(({ done, value }) => {
                if (done) {
                  updateStatus("Stream completed", "connected");
                  return;
                }

                const chunk = decoder.decode(value);
                const lines = chunk.split("\n");

                for (const line of lines) {
                  if (line.startsWith("data: ")) {
                    try {
                      const data = JSON.parse(line.slice(6));
                      handleStreamData(data);
                    } catch (e) {
                      console.error("Error parsing SSE data:", e);
                    }
                  }
                }

                return readStream();
              });
            }

            return readStream();
          })
          .catch((error) => {
            console.error("Error:", error);
            updateStatus("Error: " + error.message, "error");
            button.disabled = false;
          });
      }

      function handleStreamData(data) {
        if (data.session_id) {
          sessionId = data.session_id;
          document.getElementById(
            "sessionInfo"
          ).textContent = `Session ID: ${sessionId}`;
        }

        if (data.chunk) {
          // Add token to current message
          currentMessage += data.chunk;
          const responseSpan = document.getElementById("currentResponse");
          if (responseSpan) {
            responseSpan.textContent = currentMessage;
          }
        }

        if (data.pdf_url) {
          // Add PDF link
          addPdfLink(data.pdf_url, data.quote_id);
        }

        if (data.response) {
          // Final response received
          const responseSpan = document.getElementById("currentResponse");
          if (responseSpan) {
            responseSpan.textContent = data.response;
          }

          document.getElementById("sendButton").disabled = false;
          updateStatus("Ready for next message", "connected");
        }

        if (data.error) {
          // Error occurred
          updateStatus("Error: " + data.message, "error");
          document.getElementById("sendButton").disabled = false;
        }
      }

      // Handle Enter key
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        if (eventSource) {
          eventSource.close();
        }
      });
    </script>
  </body>
</html>
